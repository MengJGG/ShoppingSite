<!-- 购物车页面 -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>xxx的购物车</title>
    <script>
        // TODO: 获取名字，添加到title标签当中
    </script>
    <link rel="stylesheet" href="main_css.css">
    <link rel="stylesheet" href="cart.css">
    <link rel="stylesheet" href="index.css">
    <script src="../JavaResource/main.js"></script>
</head>
<body>
    <div class="sky-banner" style="cursor: pointer;"></div>
    <!-- 顶部导航栏 -->
    <div class="top-container">
        <span class="main_logo">LUXEHARMONY</span>
        <!-- 导航栏 -->
        <div class="top_guide_nav" id="top_drop_menu-container">
            <div class="header" onclick="API_jumpToPage('../WebContent/index.html')">首页
            </div>
            <div class="guitar" onclick="API_jumpToPage('../WebContent/index_guitar.html')">吉他
            </div>
            <div class="audio" onclick="API_dialog('暂未开放')">音响
            </div>
            <div class="food" onclick="API_jumpToPage('../WebContent/index_food.html')">美食
            </div>
            <div class="racket" onclick="API_jumpToPage('../WebContent/index_racket.html')">羽毛球拍
            </div>
        </div>
        <div class="search-container">

        </div>
        <div class="search-icon">
            <img src="../Resource/Img/system/clear_ico.png" id="clear" alt="X">
            <input type="text" id="search_input" placeholder="搜索...">
            <img src="../Resource/Img/system/search_ico.png" id="search" alt="搜索">
        </div>
        <!-- 登录注册 -->
        <div class="login-container">
            <img src="../Resource/Img/system/default_user_head.png" alt="">
            <div class="login_mes-container">
                <span style="cursor: default;" id="username">未登录</span>
                <section>
                    <a href="user.html" id="msg">登录</a>
                    <span style="cursor: default;">|</span>
                    <a href="user.html" id="msg">注册</a>
                </section>
            </div>
        </div>
        <script>
            const search = document.querySelector('.top-container .search-icon #search');
            const clear = document.querySelector('.top-container .search-icon #clear');
            const GuideNav = document.querySelector('.top_guide_nav');
            const searchInput = document.querySelector('.top-container .search-icon #search_input');
            
            // 处理外部点击的函数
            function handleOutsideClick(e) {
                // 判断点击目标是否在搜索区域外
                if (!e.target.closest('.search-icon')) {
                    // 执行关闭操作
                    search.style.transform = 'translateX(0)';
                    searchInput.style.transition = 'width 0.2s linear, transform 0.2s linear';
                    searchInput.style.width = '0rem';
                    searchInput.value = '';
                    clear.style.display = 'none';
                    GuideNav.style.display = 'flex';
                    GuideNav.style.animation = 'fade-in 0.2s ease 1 forwards';
                    searchInput.blur();
                    setTimeout(() => {
                        searchInput.style.display = 'none';
                        // 移除全局点击监听
                        document.removeEventListener('click', handleOutsideClick);
                    }, 200);
                    
                }
            }
            
            search.addEventListener('click', function() {
                search.style.transform = 'translateX(-32rem)';
                searchInput.style.display = 'block';
                searchInput.focus();
                searchInput.style.width = '29.4rem';
                // clear缓慢显示
                clear.style.display = 'block';
                GuideNav.style.animation = 'fade-out 0.2s ease 1 forwards';
                setTimeout(() => {
                    GuideNav.style.display = 'none';
                }, 200);
                setTimeout(() => {
                    document.addEventListener('click', handleOutsideClick);  // 添加全局点击监听
                }, 300);
            });

            searchInput.addEventListener('keydown', function(e) {
                // 按下回车键，跳转到搜索结果页面
                if (e.keyCode === 13) {
                    let keyword = searchInput.value;
                    // 如果关键字为空，则不跳转
                    if (keyword === '') {
                        return;
                    }
                    localStorage.setItem("search_keyword", keyword);
                    API_jumpToPage('../WebContent/index_search.html', flag=true);
                }
            });
            clear.addEventListener('click', function() {
                search.style.transform = 'translateX(0)';
                searchInput.style.transition = 'width 0.2s linear, transform 0.2s linear'; // 添加transform的过渡
                searchInput.style.width = '0rem';
                searchInput.value = '';
                clear.style.display = 'none';
                GuideNav.style.display = 'flex';
                GuideNav.style.animation = 'fade-in 0.2s ease 1 forwards';
                searchInput.blur();
                setTimeout(() => {
                    searchInput.style.display = 'none';
                    // 清除时移除全局点击监听
                    document.removeEventListener('click', handleOutsideClick);
                }, 200);
            });
        </script>
        <!-- 下拉菜单 -->
        <div class="top_drop_menu" id="top_drop_menu-container" data-index="0">
            <div class="drop_left-content drop_content">
                <br>
                <span id="menu_title" style="color: #333333;">按类别选购</span>
                <a onclick="API_jumpToPage('../WebContent/index_guitar.html')">吉他</a> 
                <a onclick="API_dialog('暂未开放')">音响</a>
                <a onclick="API_jumpToPage('../WebContent/index_food.html')">美食</a>
                <a onclick="API_jumpToPage('../WebContent/index_racket.html')">羽毛球拍</a>
                <br>
            </div>
            <div class="img-container">
                <br>
                <span id="menu_title" style="color: #333333;">推荐商品</span>
                <img src="../Resource/Img/food/11.jpeg" alt="" onclick=""> <!--跳转到详细页面-->
            </div>
        </div>
        <div class="top_drop_menu" id="top_drop_menu-container" data-index="1">
            <div class="drop_left-content drop_content">
                <br>
                <span id="menu_title" style="color: #333333;">热门品牌</span>
                <a onclick="API_jumpToPage('../WebContent/index_guitar.html')">Martin</a> 
                <a onclick="API_jumpToPage('../WebContent/index_guitar.html')">Fender</a>
                <a onclick="API_jumpToPage('../WebContent/index_guitar.html')">Taylor</a>
                <a onclick="API_jumpToPage('../WebContent/index_guitar.html')">Yamaha</a>
                <br>
            </div>
            <div class="img-container">
                <br>
                <span id="menu_title" style="color: #333333;">推荐商品</span>
                <img src="http://g.search3.alicdn.com/img/i3/109964830/O1CN010fvEFy1lYC1uE8Qqf_!!4611686018427383326-0-saturn_solar.jpg" alt="" onclick=""> <!--跳转到详细页面-->
            </div>
        </div>
        <div class="top_drop_menu" id="top_drop_menu-container" data-index="2">
            <div class="drop_left-content drop_content">
                <br>
                <span id="menu_title" style="color: #333333;">热门品牌</span>
                <a>JBL</a> 
                <a>Harman Kardon</a>
                <a>Denon</a>
                <a>Sony</a> 
                <a>Dynaudio</a>
                <a>Bose</a>
                <br>
            </div>
            <div class="img-container">
                <br>
                <span id="menu_title" style="color: #333333;">推荐商品</span>
                <img src="https://cn.jbl.com/dw/image/v2/AAUJ_PRD/on/demandware.static/-/Sites-masterCatalog_Harman/default/dwc471195b/01.JBL_Live Beam 3_Product Image_Feature Screen 02_Black.png?sw=537&sfrm=png" alt="" onclick=""> <!--跳转到详细页面-->
            </div>
        </div>
        <div class="top_drop_menu" id="top_drop_menu-container" data-index="3">
            <div class="drop_left-content drop_content">
                <br>
                <span id="menu_title" style="color: #333333;">牛排系列</span>
                <a>惠灵顿牛排</a> 
                <a>烟熏牛排</a>
                <a>番茄牛排</a>
                <a>法式羊排</a>
                <a>战斧牛排</a>
                <a>西芹椒盐牛排</a>
                <a>菲力牛排</a>
                <br>
            </div>
            <div class="img-container">
                <br>
                <span id="menu_title" style="color: #333333;">推荐菜品</span>
                <img src="../Resource/Img/food/41.jpeg" alt="" onclick=""> <!--跳转到详细页面-->
            </div>
        </div>
        <div class="top_drop_menu" id="top_drop_menu-container" data-index="4">
            <div class="drop_left-content drop_content">
                <br>
                <span id="menu_title" style="color: #333333;">热门品牌</span>
                <a onclick="API_jumpToPage('../WebContent/index_guitar.html')">尤尼克斯Yonex</a> 
                <a onclick="API_jumpToPage('../WebContent/index_guitar.html')">李宁LI-NING</a>
                <a onclick="API_jumpToPage('../WebContent/index_guitar.html')">威克多VICTORY</a>
                <br>
            </div>
            <div class="drop_right-content drop_content">
                <br>
                <span id="menu_title" style="color: #333333;">热门推荐</span>
                <a onclick="API_jumpToPage('../WebContent/index_racket.html', API_getIdByName('ARCSABER 11 PRO'), '')">ARCSABER 11 PRO</a> 
                <a>ARCSABER 7 PRO3</a>
                <a>NANOFLARE 700 PRO</a>
                <a>ASTROX 88S PRO</a> 
                <a>ASTROX 100 ZZ</a>
                <a>ASTROX 99 PRO</a>
            </div>
            <div class="img-container">
                <br>
                <span id="menu_title" style="color: #333333;">推荐商品</span>
                <img src="https://www.yonex.cn/public/uploads/20230904/bde83ff23ddde196fe2b3098ad993748.jpg" alt="" onclick=""> <!--跳转到详细页面-->
            </div>
        </div>
        <!-- TODO: 后端返回数据 -->
        <script>
            'use strict';
            const topGuideNav = document.querySelector('.top_guide_nav');
            const topDropMenus = document.querySelectorAll('.top_drop_menu');
            const topDropMenuContainer = document.querySelector('#top_drop_menu-container');
            topGuideNav.addEventListener('mouseover', function(e) {
                const index = Array.from(topGuideNav.children).indexOf(e.target);
                show(index);
            });
            // topDropMenus.forEach(topDropMenu => {
            //     topDropMenu.addEventListener('mouseleave', function() {
            //         topDropMenu.style.display = 'none';
            //     });
            //     topDropMenuContainer.addEventListener('mouseenter', function() {
            //         topDropMenu.style.animation = 'fade-in 0.5s ease 1 forwards';
            //         topDropMenu.style.display = 'flex';
            //     });
            // });
            topDropMenus.forEach(topDropMenu => {
                topDropMenu.addEventListener('mouseleave', function() {
                    show(-1);
                });
            });

            function show(index) {
                topDropMenus.forEach(topDropMenu => {
                    if (topDropMenu.dataset.index != index) {
                        topDropMenu.style.display = 'none';
                    }
                    else {
                        topDropMenu.style.animation = 'fade-in 0.5s ease 1 forwards';
                        topDropMenu.style.display = 'flex';
                    }
                });
            }            
            
            
        </script>
    </div>
    <!-- 侧边工具栏 -->
    <div class="side_tool_bar">
        <div class="lamp" onclick=""><img src="../Resource/Img/system/lamp.png" style="width: 2.5rem; height: 2.5rem; margin-top: 5px;" alt="开关灯"></div>
        <!-- <div class="cart" onclick="API_jumpToPage('../WebContent/cart.html')"><img src="../Resource/Img/system/cart.png" style="width: 2.4rem; height: 2.4rem; margin-top: 6px;" alt="购物车"></div> -->
        <div class="scroll_top" onclick="scrollToTop()"><img src="../Resource/Img/system/arrow_up.png" style="width: 2.7rem; height: 2.7rem;" alt="回到顶部"></div>
    </div>
    <script>
        const lamp = document.querySelector('.side_tool_bar .lamp');
        const scrollTop = document.querySelector('.side_tool_bar .scroll_top');
        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }
    </script>
    <div class="container">
        <span class="cart_logo">购物车</span>
        <br>
        <div class="cart">
            <!-- 全选 -->
            <div class="cart-header">
                <span>
                    <input type="checkbox" id="select-all" > 全选
                </span>
            </div>

            <!-- 商品栏 -->
            <div id="cart-items">
                <!-- 商品图片会通过JavaScript动态插入到这里 -->
            </div>

            <!-- 底部结算栏 -->
            <div class="cart-footer">
                <div class="total">
                    <span>总价：<span id="total-price">0</span>元</span>
                </div>
                <button id="checkout">结算</button>
            </div>
        </div>
    </div>

    <script>

        // 购物车（商品）数据
        // let cart = [
        //     {
        //         id: 1,
        //         name: "商品A",
        //         price: 156,
        //         quantity: 1,
        //         image: "image/2.jpeg",
        //         selected: true,
        //     },
        //     {
        //         id: 2,
        //         name: "商品B",
        //         price: 243,
        //         quantity: 2,
        //         image: "image/21.jpeg", 
        //         selected: false,
        //     },
        //     {
        //         id: 3,
        //         name: "商品C",
        //         price: 99,
        //         quantity: 1,
        //         image: "image/3.jpeg", 
        //         selected: true,
        //     },
        //     {
        //         id: 4,
        //         name: "商品D",
        //         price: 106,
        //         quantity: 3,
        //         image: "image/22.jpeg", 
        //         selected: false,
        //     },
        //     {
        //         id: 5,
        //         name: "商品E",
        //         price: 188,
        //         quantity: 2,
        //         image: "image/16.jpeg", 
        //         selected: true,
        //     },
        // ]

        let cart = API_getGoodsFromCart(); // 从服务器获取购物车数据

        // cart: Array<dict>
        // 为每个商品添加"quantity"属性，用于记录购买数量，以及"selected"属性，用于记录是否被选中默认true
        cart.forEach((item) => {
            item["quantity"] = 1;
            item["selected"] = true;
        });

        // 渲染购物车
        function renderCart() {
            const cartItems = document.getElementById("cart-items")
            const totalPrice = document.getElementById("total-price")
            let total = 0

            // 清空购物车列表
            cartItems.innerHTML = ""

           //进行渲染
            cart.forEach((item, index) => {
                const itemElement = document.createElement("div")
                itemElement.classList.add("cart-item")

                itemElement.innerHTML = `
                    <label>
                        <input type="checkbox" class="item-checkbox" data-index="${index}" ${item.selected ? "checked" : ""}>
                    </label>
                    <img src="${item.image_url}" alt="${item.name}">
                    <div class="info">
                        <h3>${item.name}</h3>
                        <p>价格：${item.price}元</p>
                    </div>
                    <div class="quantity">
                        <button onclick="changeQuantity(${index}, -1)">-</button>
                        <input type="text" value="${item.quantity}" onchange="updateQuantity(${index}, this.value)">
                        <button onclick="changeQuantity(${index}, 1)">+</button>
                    </div>
                    <div class="delete" onclick="removeItem(${index})">删除</div>
                `

                cartItems.appendChild(itemElement)

                // 计算总价
                if (item.selected) {
                    // 去除item.price中的￥和$符号和空格，并转为数字类型
                    let price = parseFloat(item.price.replace(/[^\d.]/g, ''));


                    total += price * item.quantity;
                }
            });

            // 更新总价，保留两位小数
            total = total.toFixed(2)
            totalPrice.textContent = total
        }

        // 修改商品数量
        function changeQuantity(index, delta) {
            cart[index].quantity += delta
            if (cart[index].quantity < 1) {
                cart[index].quantity = 1
            }
            renderCart()
        }

        // 更新商品数量
        function updateQuantity(index, value) {
            const quantity = parseInt(value, 10)
            if (!isNaN(quantity)) {
                cart[index].quantity = quantity
                renderCart()
            }
        }

        // 删除商品
        function removeItem(index) {
            cart.splice(index, 1)
            renderCart()
        }

        // 全选/反选
        document.getElementById("select-all").addEventListener("change", function () {
            const isChecked = this.checked
            cart.forEach((item) => (item.selected = isChecked))
            renderCart()
        })

        // 结算
        document.getElementById("checkout").addEventListener("click", function () {
            const selectedItems = cart.filter((item) => item.selected)
            if (selectedItems.length === 0) {
                alert("请选择至少一件商品！")
            } else {
                alert(`结算成功！共 ${selectedItems.length} 件商品，总价：${document.getElementById("total-price").textContent}元`)
            }
        })
        renderCart()
    </script>
</body>
</html>